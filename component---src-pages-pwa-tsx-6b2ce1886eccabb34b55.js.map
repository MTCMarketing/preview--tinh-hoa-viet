{"version":3,"file":"component---src-pages-pwa-tsx-6b2ce1886eccabb34b55.js","mappings":"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","sources":["webpack:///./src/hooks/usePushNotificationSubscription.tsx","webpack:///./src/pages/pwa.tsx"],"sourcesContent":["\n\nconst VAPID_PUBLIC_KEY =\n  \"BBBhf0wej5fkbxA9XcDE3fvbJRWCdTL61plMN8KdtMkWeKMzVF7b-5YBfLH__vJpq5CqrFqy3ittbRr4PtNCWcM\";\nimport { useState } from \"react\";\nimport { supabase } from \"../database/supabaseClient\";\n\n\nfunction urlBase64ToUint8Array(base64String: string) {\n  const padding = \"=\".repeat((4 - (base64String.length % 4)) % 4);\n  const base64 = (base64String + padding).replace(/-/g, \"+\").replace(/_/g, \"/\");\n  const raw = atob(base64);\n  return Uint8Array.from([...raw].map(ch => ch.charCodeAt(0)));\n}\n\nexport function usePushSubscription() {\n  const [status, setStatus] = useState(\"\");\n\n  async function subscribe(data: { name?: string; email?: string; device?: string }) {\n    try {\n      setStatus(\"Checking permission…\");\n\n      // 1. Ask permission\n      const perm = await Notification.requestPermission();\n      if (perm !== \"granted\") {\n        throw new Error(\"Permission denied by browser\");\n      }\n\n      // 2. Wait for SW\n      const reg = await navigator.serviceWorker.ready;\n\n      // 3. Check for an existing subscription FIRST\n      const existing = await reg.pushManager.getSubscription();\n      if (existing) {\n        setStatus(\"Already subscribed — updating db…\");\n        await supabase.from(\"push_subscriptions\").insert({\n          subscription: existing.toJSON(),\n          name: data.name || null,\n          email: data.email || null,\n          device: data.device || \"primary phone\"\n        });\n        return existing;\n      }\n\n      // 4. Subscribe\n      setStatus(\"Subscribing…\");\n      const sub = await reg.pushManager.subscribe({\n        userVisibleOnly: true,\n        applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)\n      });\n\n      // 5. Save\n      const { error } = await supabase.from(\"push_subscriptions\").insert({\n        subscription: sub.toJSON(),\n        name: data.name || null,\n        email: data.email || null,\n        device: data.device || \"primary phone\"\n      });\n\n      if (error) throw new Error(error.message);\n\n      setStatus(\"Subscribed!\");\n      return sub;\n\n    } catch (err: any) {\n      setStatus(\"Failed: \" + err.message);\n      throw err;\n    }\n  }\n\n  return { subscribe, status };\n}\n\n","import React, { useEffect, useState } from \"react\";\nimport { usePushSubscription } from \"../hooks/usePushNotificationSubscription\";\nimport { supabase } from \"../database/supabaseClient\";\n\n/* ----------------------------------------------------\n   SAFE PLATFORM DETECTION (SSR-PROOF)\n---------------------------------------------------- */\nfunction safeIsIos() {\n  if (typeof navigator === \"undefined\") return false;\n  return /iphone|ipad|ipod/i.test(navigator.userAgent);\n}\n\nfunction safeIsStandalone() {\n  if (typeof window === \"undefined\" || typeof navigator === \"undefined\") return false;\n  return (\n    window.matchMedia(\"(display-mode: standalone)\").matches ||\n    (navigator as any).standalone === true\n  );\n}\n\nfunction safeIsAndroid() {\n  if (typeof navigator === \"undefined\") return false;\n  return /android/i.test(navigator.userAgent);\n}\n\n/* ----------------------------------------------------\n   INLINE iOS INSTALL OVERLAY\n---------------------------------------------------- */\nfunction IosInstallOverlay({ onClose }: { onClose: () => void }) {\n  return (\n    <div\n      style={{\n        position: \"fixed\",\n        inset: 0,\n        background: \"rgba(0,0,0,0.65)\",\n        color: \"white\",\n        padding: \"2rem\",\n        zIndex: 9999\n      }}\n    >\n      <div\n        style={{\n          maxWidth: 400,\n          margin: \"0 auto\",\n          background: \"#222\",\n          padding: 20,\n          borderRadius: 12\n        }}\n      >\n        <h2>Install this App</h2>\n        <p>To enable notifications on your iPhone:</p>\n\n        <ol>\n          <li>\n            Tap the <strong>Share</strong> button{\" \"}\n            <span style={{ fontSize: \"1.3rem\" }}>⬆️</span>\n          </li>\n          <li>\n            Choose <strong>Add to Home Screen</strong>\n          </li>\n          <li>Re-open the app from your home screen</li>\n        </ol>\n\n        <button\n          onClick={onClose}\n          style={{\n            marginTop: 20,\n            padding: \"8px 14px\",\n            background: \"#555\",\n            color: \"white\",\n            borderRadius: 6\n          }}\n        >\n          Got it\n        </button>\n      </div>\n    </div>\n  );\n}\n\n/* ----------------------------------------------------\n   SEND PUSH HELPER\n---------------------------------------------------- */\nasync function sendPushMessage(title: string, body: string) {\n  const { data, error } = await supabase\n    .from(\"push_subscriptions\")\n    .select(\"subscription\")\n    .order(\"created_at\", { ascending: false })\n    .limit(1)\n    .maybeSingle();\n\n  if (error) throw new Error(error.message);\n  if (!data) throw new Error(\"No subscriptions found.\");\n\n  const subscription = data.subscription;\n\n  const res = await fetch(\"https://auth.tinhhoaviet.org.vn/push\", {\n    method: \"POST\",\n    headers: { \"Content-Type\": \"application/json\" },\n    body: JSON.stringify({\n      secret: \"Zf8uP1q9R4x!bA72Lk@cM39vD$wQeT6\",\n      subscription: subscription,\n      title,\n      body\n    })\n  });\n\n  const txt = await res.text();\n  if (!res.ok) throw new Error(txt);\n\n  return \"Push sent!\";\n}\n\n/* ----------------------------------------------------\n   MAIN PAGE (ALL-IN-ONE)\n---------------------------------------------------- */\nexport default function PwaSubscribePage() {\n  const { subscribe, status } = usePushSubscription();\n\n  const [name, setName] = useState(\"\");\n  const [email, setEmail] = useState(\"\");\n  const [device, setDevice] = useState(\"primary phone\");\n\n  const [pushTitle, setPushTitle] = useState(\"Test Message\");\n  const [pushBody, setPushBody] = useState(\"Hello from THV!\");\n  const [pushStatus, setPushStatus] = useState(\"\");\n\n  const [showIosPrompt, setShowIosPrompt] = useState(false);\n\n  /* Register service worker for /pwa/ scope */\n  useEffect(() => {\n    if (typeof navigator !== \"undefined\" && \"serviceWorker\" in navigator) {\n      navigator.serviceWorker.register(\"/pwa/service-worker.js\", {\n        scope: \"/pwa/\"\n      });\n    }\n  }, []);\n\n  /* Detect iOS + not PWA */\n  useEffect(() => {\n    if (safeIsIos() && !safeIsStandalone()) {\n      setShowIosPrompt(true);\n    }\n  }, []);\n\n  async function handleSubscribe() {\n    await subscribe({ name, email, device });\n  }\n\n  async function handleSendPush() {\n    setPushStatus(\"Sending…\");\n    try {\n      const msg = await sendPushMessage(pushTitle, pushBody);\n      setPushStatus(msg);\n    } catch (err: any) {\n      setPushStatus(err.message);\n    }\n  }\n\n  return (\n    <div style={{ padding: \"2rem\", maxWidth: 600, margin: \"0 auto\" }}>\n      <h1>Web Push Notifications</h1>\n\n      {safeIsAndroid() && (\n        <p style={{ color: \"#0a0\" }}>\n          Android detected. Push works directly in browser. No install required.\n        </p>\n      )}\n\n      {safeIsIos() && safeIsStandalone() && (\n        <p style={{ color: \"#0a0\" }}>\n          iOS PWA mode detected. Push subscription is supported.\n        </p>\n      )}\n\n      {safeIsIos() && !safeIsStandalone() && (\n        <p style={{ color: \"orange\" }}>\n          iPhone detected. Install the app first to enable notifications.\n        </p>\n      )}\n\n      <h2>Subscribe</h2>\n\n      <label>Name</label>\n      <input\n        value={name}\n        onChange={e => setName(e.target.value)}\n        placeholder=\"Your name\"\n        style={{ width: \"100%\", marginBottom: \"1rem\" }}\n      />\n\n      <label>Email</label>\n      <input\n        value={email}\n        onChange={e => setEmail(e.target.value)}\n        placeholder=\"you@example.com\"\n        style={{ width: \"100%\", marginBottom: \"1rem\" }}\n      />\n\n      <label>Device</label>\n      <input\n        value={device}\n        onChange={e => setDevice(e.target.value)}\n        placeholder=\"primary phone\"\n        style={{ width: \"100%\", marginBottom: \"1rem\" }}\n      />\n\n      <button onClick={handleSubscribe}>Subscribe Now</button>\n\n      {status && <p>{status}</p>}\n\n      <hr style={{ margin: \"2rem 0\" }} />\n\n      <h2>Send Push</h2>\n\n      <label>Title</label>\n      <input\n        value={pushTitle}\n        onChange={e => setPushTitle(e.target.value)}\n        style={{ width: \"100%\", marginBottom: \"1rem\" }}\n      />\n\n      <label>Message</label>\n      <textarea\n        value={pushBody}\n        onChange={e => setPushBody(e.target.value)}\n        rows={3}\n        style={{ width: \"100%\", marginBottom: \"1rem\" }}\n      />\n\n      <button onClick={handleSendPush}>Send Push</button>\n\n      {pushStatus && <p>{pushStatus}</p>}\n\n      {showIosPrompt && <IosInstallOverlay onClose={() => setShowIosPrompt(false)} />}\n    </div>\n  );\n}\n"],"names":["VAPID_PUBLIC_KEY","urlBase64ToUint8Array","base64String","base64","repeat","length","replace","raw","atob","Uint8Array","from","_toConsumableArray","map","ch","charCodeAt","safeIsIos","navigator","test","userAgent","safeIsStandalone","window","matchMedia","matches","standalone","IosInstallOverlay","onClose","React","style","position","inset","background","color","padding","zIndex","maxWidth","margin","borderRadius","fontSize","onClick","marginTop","PwaSubscribePage","subscribe","status","setStatus","useState","async","data","Notification","requestPermission","Error","reg","serviceWorker","ready","existing","pushManager","getSubscription","supabase","insert","subscription","toJSON","name","email","device","sub","userVisibleOnly","applicationServerKey","error","message","err","usePushSubscription","setName","setEmail","setDevice","pushTitle","setPushTitle","pushBody","setPushBody","pushStatus","setPushStatus","showIosPrompt","setShowIosPrompt","useEffect","register","scope","value","onChange","e","target","placeholder","width","marginBottom","rows","msg","title","body","select","order","ascending","limit","maybeSingle","res","fetch","method","headers","JSON","stringify","secret","txt","text","ok","sendPushMessage"],"sourceRoot":""}